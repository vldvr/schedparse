<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <title>Управление резервными копиями</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css">
    <style>
        :root {
            --primary-color: #0d6efd;
            --success-color: #198754;
            --warning-color: #ffc107;
            --danger-color: #dc3545;
            --light-gray: #f8f9fa;
            --medium-gray: #e9ecef;
            --card-shadow: 0 8px 30px rgba(0, 0, 0, 0.05);
            --card-radius: 1rem;
        }
        body {
            font-family: 'Inter', sans-serif;
            background-color: var(--light-gray);
        }
        .main-card {
            background: #fff;
            border-radius: var(--card-radius);
            box-shadow: var(--card-shadow);
            padding: 2.5rem;
            margin-top: 3rem;
            margin-bottom: 3rem;
            border: 1px solid var(--medium-gray);
        }
        .page-header {
            margin-bottom: 2rem;
            padding-bottom: 1.5rem;
            border-bottom: 1px solid var(--medium-gray);
        }
        .page-header h2 {
            font-weight: 700;
        }
        .action-card {
            background-color: var(--light-gray);
            border-radius: 0.75rem;
            padding: 1.5rem;
            margin-bottom: 2rem;
        }
        .backup-list {
            background-color: #fff;
            border-radius: 0.75rem;
            border: 1px solid var(--medium-gray);
        }
        .backup-item {
            padding: 1rem 1.5rem;
            border-bottom: 1px solid var(--medium-gray);
            display: flex;
            justify-content: space-between;
            align-items: center;
            transition: background-color 0.2s ease;
        }
        .backup-item:hover {
            background-color: rgba(13, 110, 253, 0.05);
        }
        .backup-item:last-child {
            border-bottom: none;
        }
        .backup-info h6 {
            margin-bottom: 0.25rem;
            font-weight: 500;
        }
        .backup-info .text-muted {
            font-size: 0.9em;
        }
        .backup-actions {
            display: flex;
            gap: 0.5rem;
        }
        .security-warning {
            background: linear-gradient(135deg, #fff3cd, #ffeaa7);
            border: 1px solid #ffc107;
            border-radius: 0.75rem;
            padding: 1.5rem;
            margin-bottom: 2rem;
        }
        .security-warning h5 {
            color: #b45309;
            margin-bottom: 1rem;
        }
        .security-warning ul {
            color: #856404;
            margin-bottom: 0;
        }
        .modal-body .form-label {
            font-weight: 500;
        }
        .progress-container {
            display: none;
            margin-top: 1rem;
        }
        .alert-container {
            margin-top: 1rem;
        }
    </style>
</head>
<body>
<div class="container">
    <div class="main-card">
        <div class="page-header d-flex justify-content-between align-items-center">
            <h2 class="mb-0">
                <i class="bi bi-shield-check text-primary"></i> 
                Управление резервными копиями
            </h2>
            <a href="{{ url_for('admin_dashboard') }}" class="btn btn-outline-secondary">
                <i class="bi bi-arrow-left"></i> Назад
            </a>
        </div>

        <div class="security-warning">
            <h5><i class="bi bi-exclamation-triangle-fill me-2"></i>Важная информация о безопасности</h5>
            <ul>
                <li><strong>Бэкапы зашифрованы</strong> - используйте надежные пароли длиной не менее 12 символов</li>
                <li><strong>Сохраняйте пароли отдельно</strong> - без пароля восстановить данные невозможно</li>
                <li><strong>Автоматические бэкапы</strong> создаются каждое воскресенье в 3:00 утра</li>
                <li><strong>Восстановление</strong> полностью заменяет текущие данные</li>
            </ul>
        </div>

        <div class="row g-4 mb-4">
            <div class="col-md-6">
                <div class="action-card h-100">
                    <h5 class="mb-3"><i class="bi bi-plus-circle text-success"></i> Создать бэкап</h5>
                    <p class="text-muted mb-3">Создать зашифрованную резервную копию всех данных и изображений</p>
                    <button class="btn btn-success" data-bs-toggle="modal" data-bs-target="#createBackupModal">
                        <i class="bi bi-download"></i> Создать бэкап
                    </button>
                </div>
            </div>
            <div class="col-md-6">
                <div class="action-card h-100">
                    <h5 class="mb-3"><i class="bi bi-upload text-primary"></i> Восстановить бэкап</h5>
                    <p class="text-muted mb-3">Загрузить и восстановить данные из зашифрованного бэкапа</p>
                    <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#restoreBackupModal">
                        <i class="bi bi-upload"></i> Восстановить
                    </button>
                </div>
            </div>
        </div>

        <h4 class="mb-3">Доступные бэкапы</h4>
        <div class="backup-list">
            {% if backups %}
                {% for backup in backups %}
                <div class="backup-item">
                    <div class="backup-info">
                        <h6>{{ backup.filename }}</h6>
                        <div class="text-muted">
                            <i class="bi bi-calendar3 me-1"></i>{{ backup.created_at.strftime('%d.%m.%Y %H:%M') }}
                            <span class="ms-3">
                                <i class="bi bi-file-earmark-zip me-1"></i>{{ "%.2f"|format(backup.size / 1024 / 1024) }} MB
                            </span>
                        </div>
                    </div>
                    <div class="backup-actions">
                        <a href="{{ url_for('admin_download_backup', filename=backup.filename) }}" 
                           class="btn btn-sm btn-outline-primary" title="Скачать">
                            <i class="bi bi-download"></i>
                        </a>
                        <button class="btn btn-sm btn-outline-danger" 
                                onclick="deleteBackup('{{ backup.filename }}')" title="Удалить">
                            <i class="bi bi-trash"></i>
                        </button>
                    </div>
                </div>
                {% endfor %}
            {% else %}
                <div class="backup-item text-center">
                    <div class="text-muted p-4">
                        <i class="bi bi-inbox display-4 mb-3"></i>
                        <p>Бэкапы не найдены</p>
                    </div>
                </div>
            {% endif %}
        </div>
    </div>
</div>

<div class="modal fade" id="createBackupModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Создание бэкапа</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="createBackupForm">
                    <div class="mb-3">
                        <label for="backup_password" class="form-label">Пароль для шифрования</label>
                        <input type="password" class="form-control" id="backup_password" 
                               placeholder="Минимум 8 символов" minlength="8" required>
                        <div class="form-text">Этот пароль потребуется для восстановления бэкапа</div>
                    </div>
                    <div class="mb-3">
                        <label for="backup_password_confirm" class="form-label">Подтвердите пароль</label>
                        <input type="password" class="form-control" id="backup_password_confirm" 
                               placeholder="Повторите пароль" required>
                    </div>
                </form>
                <div class="progress-container">
                    <div class="progress">
                        <div class="progress-bar progress-bar-striped progress-bar-animated" 
                             style="width: 0%"></div>
                    </div>
                    <small class="text-muted mt-2">Создание бэкапа может занять несколько минут...</small>
                </div>
                <div class="alert-container"></div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Отмена</button>
                <button type="button" class="btn btn-success" id="createBackupBtn">
                    <i class="bi bi-download me-1"></i>Создать бэкап
                </button>
            </div>
        </div>
    </div>
</div>

<div class="modal fade" id="restoreBackupModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Восстановление из бэкапа</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div class="alert alert-warning">
                    <i class="bi bi-exclamation-triangle-fill me-2"></i>
                    <strong>Внимание!</strong> Восстановление полностью заменит все текущие данные и изображения.
                </div>
                <form id="restoreBackupForm" enctype="multipart/form-data">
                    <div class="mb-3">
                        <label for="backup_file" class="form-label">Файл бэкапа</label>
                        <input type="file" class="form-control" id="backup_file" 
                               accept=".encrypted" required>
                        <div class="form-text">Выберите файл с расширением .encrypted</div>
                    </div>
                    <div class="mb-3">
                        <label for="restore_password" class="form-label">Пароль для расшифровки</label>
                        <input type="password" class="form-control" id="restore_password" 
                               placeholder="Введите пароль от бэкапа" required>
                    </div>
                </form>
                <div class="progress-container">
                    <div class="progress">
                        <div class="progress-bar progress-bar-striped progress-bar-animated" 
                             style="width: 0%"></div>
                    </div>
                    <small class="text-muted mt-2">Восстановление может занять несколько минут...</small>
                </div>
                <div class="alert-container"></div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Отмена</button>
                <button type="button" class="btn btn-danger" id="restoreBackupBtn">
                    <i class="bi bi-upload me-1"></i>Восстановить
                </button>
            </div>
        </div>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
<script>
// Создание бэкапа
document.getElementById('createBackupBtn').addEventListener('click', function() {
    const password = document.getElementById('backup_password').value;
    const confirmPassword = document.getElementById('backup_password_confirm').value;
    const alertContainer = document.querySelector('#createBackupModal .alert-container');
    
    // Очистка предыдущих сообщений
    alertContainer.innerHTML = '';
    
    // Валидация паролей
    if (password !== confirmPassword) {
        alertContainer.innerHTML = '<div class="alert alert-danger">Пароли не совпадают</div>';
        return;
    }
    
    if (password.length < 8) {
        alertContainer.innerHTML = '<div class="alert alert-danger">Пароль должен содержать минимум 8 символов</div>';
        return;
    }
    
    // Показать прогресс-бар
    document.querySelector('#createBackupModal .progress-container').style.display = 'block';
    document.getElementById('createBackupBtn').disabled = true;
    
    // Анимация прогресса
    let progress = 0;
    const progressBar = document.querySelector('#createBackupModal .progress-bar');
    const progressInterval = setInterval(() => {
        progress += Math.random() * 15;
        if (progress > 90) progress = 90;
        progressBar.style.width = progress + '%';
    }, 500);
    
    // Отправка запроса
    const formData = new FormData();
    formData.append('backup_password', password);
    
    fetch('/admin/backup/create', {
        method: 'POST',
        body: formData
    })
    .then(response => response.json())
    .then(data => {
        clearInterval(progressInterval);
        progressBar.style.width = '100%';
        
        if (data.success) {
            alertContainer.innerHTML = `<div class="alert alert-success">${data.message}</div>`;
            setTimeout(() => {
                location.reload();
            }, 2000);
        } else {
            alertContainer.innerHTML = `<div class="alert alert-danger">Ошибка: ${data.error}</div>`;
        }
    })
    .catch(error => {
        clearInterval(progressInterval);
        alertContainer.innerHTML = '<div class="alert alert-danger">Произошла ошибка при создании бэкапа</div>';
    })
    .finally(() => {
        document.getElementById('createBackupBtn').disabled = false;
        setTimeout(() => {
            document.querySelector('#createBackupModal .progress-container').style.display = 'none';
            progressBar.style.width = '0%';
        }, 3000);
    });
});

// Восстановление бэкапа
document.getElementById('restoreBackupBtn').addEventListener('click', function() {
    const fileInput = document.getElementById('backup_file');
    const password = document.getElementById('restore_password').value;
    const alertContainer = document.querySelector('#restoreBackupModal .alert-container');
    
    // Очистка предыдущих сообщений
    alertContainer.innerHTML = '';
    
    if (!fileInput.files[0]) {
        alertContainer.innerHTML = '<div class="alert alert-danger">Выберите файл бэкапа</div>';
        return;
    }
    
    if (!password) {
        alertContainer.innerHTML = '<div class="alert alert-danger">Введите пароль</div>';
        return;
    }
    
    // Показать прогресс-бар
    document.querySelector('#restoreBackupModal .progress-container').style.display = 'block';
    document.getElementById('restoreBackupBtn').disabled = true;
    
    // Анимация прогресса
    let progress = 0;
    const progressBar = document.querySelector('#restoreBackupModal .progress-bar');
    const progressInterval = setInterval(() => {
        progress += Math.random() * 10;
        if (progress > 85) progress = 85;
        progressBar.style.width = progress + '%';
    }, 800);
    
    // Отправка запроса
    const formData = new FormData();
    formData.append('backup_file', fileInput.files[0]);
    formData.append('restore_password', password);
    
    fetch('/admin/backup/restore', {
        method: 'POST',
        body: formData
    })
    .then(response => response.json())
    .then(data => {
        clearInterval(progressInterval);
        progressBar.style.width = '100%';
        
        if (data.success) {
            alertContainer.innerHTML = `<div class="alert alert-success">${data.message}</div>`;
        } else {
            alertContainer.innerHTML = `<div class="alert alert-danger">Ошибка: ${data.error}</div>`;
        }
    })
    .catch(error => {
        clearInterval(progressInterval);
        alertContainer.innerHTML = '<div class="alert alert-danger">Произошла ошибка при восстановлении</div>';
    })
    .finally(() => {
        document.getElementById('restoreBackupBtn').disabled = false;
        setTimeout(() => {
            document.querySelector('#restoreBackupModal .progress-container').style.display = 'none';
            progressBar.style.width = '0%';
        }, 3000);
    });
});

// Удаление бэкапа
function deleteBackup(filename) {
    if (!confirm('Вы уверены, что хотите удалить этот бэкап?')) {
        return;
    }
    
    fetch(`/admin/backup/delete/${filename}`, {
        method: 'POST'
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            location.reload();
        } else {
            alert('Ошибка: ' + data.error);
        }
    })
    .catch(error => {
        alert('Произошла ошибка при удалении бэкапа');
    });
}

// Сброс форм при закрытии модальных окон
document.getElementById('createBackupModal').addEventListener('hidden.bs.modal', function() {
    document.getElementById('createBackupForm').reset();
    document.querySelector('#createBackupModal .alert-container').innerHTML = '';
    document.querySelector('#createBackupModal .progress-container').style.display = 'none';
});

document.getElementById('restoreBackupModal').addEventListener('hidden.bs.modal', function() {
    document.getElementById('restoreBackupForm').reset();
    document.querySelector('#restoreBackupModal .alert-container').innerHTML = '';
    document.querySelector('#restoreBackupModal .progress-container').style.display = 'none';
});
</script>
</body>
</html>