<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <title>Управление резервными копиями</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css">
    <style>
        :root {
            --primary-color: #0d6efd;
            --success-color: #198754;
            --warning-color: #ffc107;
            --danger-color: #dc3545;
            --light-gray: #f8f9fa;
            --medium-gray: #e9ecef;
            --card-shadow: 0 8px 30px rgba(0, 0, 0, 0.05);
            --card-radius: 1rem;
        }
        body {
            font-family: 'Inter', sans-serif;
            background-color: var(--light-gray);
        }
        .main-card {
            background: #fff;
            border-radius: var(--card-radius);
            box-shadow: var(--card-shadow);
            padding: 2.5rem;
            margin-top: 3rem;
            margin-bottom: 3rem;
            border: 1px solid var(--medium-gray);
        }
        .page-header {
            margin-bottom: 2rem;
            padding-bottom: 1.5rem;
            border-bottom: 1px solid var(--medium-gray);
        }
        .page-header h2 {
            font-weight: 700;
        }
        .action-card {
            background-color: var(--light-gray);
            border-radius: 0.75rem;
            padding: 1.5rem;
            margin-bottom: 2rem;
        }
        .backup-list {
            background-color: #fff;
            border-radius: 0.75rem;
            border: 1px solid var(--medium-gray);
        }
        .backup-item {
            padding: 1rem 1.5rem;
            border-bottom: 1px solid var(--medium-gray);
            display: flex;
            justify-content: space-between;
            align-items: center;
            transition: background-color 0.2s ease;
        }
        .backup-item:hover {
            background-color: rgba(13, 110, 253, 0.05);
        }
        .backup-item:last-child {
            border-bottom: none;
        }
        .backup-info h6 {
            margin-bottom: 0.25rem;
            font-weight: 500;
        }
        .backup-info .text-muted {
            font-size: 0.9em;
        }
        .backup-actions {
            display: flex;
            gap: 0.5rem;
            flex-wrap: wrap;
        }
        .security-warning {
            background: linear-gradient(135deg, #fff3cd, #ffeaa7);
            border: 1px solid #ffc107;
            border-radius: 0.75rem;
            padding: 1.5rem;
            margin-bottom: 2rem;
        }
        .security-warning h5 {
            color: #b45309;
            margin-bottom: 1rem;
        }
        .security-warning ul {
            color: #856404;
            margin-bottom: 0;
        }
        .modal-body .form-label {
            font-weight: 500;
        }
        .progress-container {
            display: none;
            margin-top: 1rem;
        }
        .alert-container {
            margin-top: 1rem;
        }
        .backup-type {
            font-size: 0.75rem;
            padding: 0.2rem 0.5rem;
            border-radius: 0.25rem;
            font-weight: 500;
            text-transform: uppercase;
        }
        .backup-auto {
            background-color: #d1ecf1;
            color: #0c5460;
        }
        .backup-manual {
            background-color: #fff3cd;
            color: #856404;
        }
        .nas-status {
            padding: 0.5rem 1rem;
            border-radius: 0.5rem;
            font-weight: 500;
            font-size: 0.9rem;
        }
        .nas-enabled {
            background-color: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }
        .nas-disabled {
            background-color: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }
        .nas-info-card {
            background: linear-gradient(135deg, #e3f2fd, #bbdefb);
            border: 1px solid #2196f3;
            border-radius: 0.75rem;
            padding: 1.5rem;
            margin-bottom: 2rem;
        }
    </style>
</head>
<body>
<div class="container">
    <div class="main-card">
        <div class="page-header d-flex justify-content-between align-items-center">
            <div>
                <h2 class="mb-1">
                    <i class="bi bi-shield-check text-primary"></i> 
                    Управление резервными копиями
                </h2>
                <div class="nas-status {{ 'nas-enabled' if nas_config.get('enabled') else 'nas-disabled' }}">
                    <i class="bi bi-{{ 'wifi' if nas_config.get('enabled') else 'wifi-off' }}"></i>
                    NAS: {{ 'Включен' if nas_config.get('enabled') else 'Отключен' }}
                </div>
            </div>
            <a href="{{ url_for('admin_dashboard') }}" class="btn btn-outline-secondary">
                <i class="bi bi-arrow-left"></i> Назад
            </a>
        </div>

        <!-- NAS Information Card -->
        {% if nas_config.get('enabled') %}
        <div class="nas-info-card">
            <h5><i class="bi bi-cloud-upload text-primary me-2"></i>NAS Подключение</h5>
            <div class="row">
                <div class="col-md-6">
                    <p class="mb-1"><strong>Хост:</strong> {{ nas_config.get('host', 'Не указан') }}</p>
                    <p class="mb-1"><strong>Шара:</strong> {{ nas_config.get('share', 'Не указана') }}</p>
                </div>
                <div class="col-md-6">
                    <p class="mb-1"><strong>Путь:</strong> {{ nas_config.get('path', 'Не указан') }}</p>
                    <p class="mb-1"><strong>Автозагрузка:</strong> Включена для месячных бэкапов</p>
                </div>
            </div>
            <button type="button" class="btn btn-sm btn-primary" onclick="testNasConnection()">
                <i class="bi bi-wifi me-1"></i>Тест подключения
            </button>
        </div>
        {% endif %}

        <div class="security-warning">
            <h5><i class="bi bi-exclamation-triangle-fill me-2"></i>Важная информация о безопасности</h5>
            <ul>
                <li><strong>Бэкапы зашифрованы</strong> - используйте надежные пароли длиной не менее 12 символов</li>
                <li><strong>Сохраняйте пароли отдельно</strong> - без пароля восстановить данные невозможно</li>
                <li><strong>Автоматические бэкапы</strong> создаются 1-го числа каждого месяца в 3:00 утра</li>
                <li><strong>Восстановление</strong> полностью заменяет текущие данные</li>
                {% if nas_config.get('enabled') %}
                <li><strong>NAS бэкапы</strong> - месячные бэкапы автоматически загружаются на NAS (хранится 12 последних)</li>
                {% endif %}
            </ul>
        </div>

        <div class="row g-4 mb-4">
            <div class="col-md-4">
                <div class="action-card h-100">
                    <h5 class="mb-3"><i class="bi bi-plus-circle text-success"></i> Создать бэкап</h5>
                    <p class="text-muted mb-3">Создать зашифрованную резервную копию всех данных и изображений</p>
                    <button class="btn btn-success" data-bs-toggle="modal" data-bs-target="#createBackupModal">
                        <i class="bi bi-download"></i> Создать бэкап
                    </button>
                </div>
            </div>
            <div class="col-md-4">
                <div class="action-card h-100">
                    <h5 class="mb-3"><i class="bi bi-upload text-primary"></i> Восстановить бэкап</h5>
                    <p class="text-muted mb-3">Загрузить и восстановить данные из зашифрованного бэкапа</p>
                    <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#restoreBackupModal">
                        <i class="bi bi-upload"></i> Восстановить
                    </button>
                </div>
            </div>
            <div class="col-md-4">
                <div class="action-card h-100">
                    <h5 class="mb-3"><i class="bi bi-calendar-check text-warning"></i> Месячный бэкап</h5>
                    <p class="text-muted mb-3">Принудительно создать месячный бэкап и отправить на NAS</p>
                    <button class="btn btn-warning" onclick="forceMonthlyBackup()">
                        <i class="bi bi-cloud-arrow-up"></i> Месячный бэкап
                    </button>
                </div>
            </div>
        </div>

        <h4 class="mb-3">Доступные бэкапы</h4>
        <div class="backup-list">
            {% if backups %}
                {% for backup in backups %}
                <div class="backup-item">
                    <div class="backup-info">
                        <h6>
                            {{ backup.filename }}
                            <span class="backup-type backup-{{ backup.get('backup_type', 'manual') }}">
                                {{ 'авто' if backup.get('backup_type') == 'auto' else 'ручной' }}
                            </span>
                        </h6>
                        <div class="text-muted">
                            <i class="bi bi-calendar3 me-1"></i>{{ backup.created_at.strftime('%d.%m.%Y %H:%M') }}
                            <span class="ms-3">
                                <i class="bi bi-file-earmark-zip me-1"></i>{{ "%.2f"|format(backup.size / 1024 / 1024) }} MB
                            </span>
                        </div>
                    </div>
                    <div class="backup-actions">
                        <a href="{{ url_for('admin_download_backup', filename=backup.filename) }}" 
                           class="btn btn-sm btn-outline-primary" title="Скачать">
                            <i class="bi bi-download"></i>
                        </a>
                        {% if nas_config.get('enabled') %}
                        <button class="btn btn-sm btn-outline-success" 
                                onclick="uploadToNas('{{ backup.filename }}')" title="Загрузить на NAS">
                            <i class="bi bi-cloud-upload"></i>
                        </button>
                        {% endif %}
                        <button class="btn btn-sm btn-outline-danger" 
                                onclick="deleteBackup('{{ backup.filename }}')" title="Удалить">
                            <i class="bi bi-trash"></i>
                        </button>
                    </div>
                </div>
                {% endfor %}
            {% else %}
                <div class="backup-item text-center">
                    <div class="text-muted p-4">
                        <i class="bi bi-inbox display-4 mb-3"></i>
                        <p>Бэкапы не найдены</p>
                    </div>
                </div>
            {% endif %}
        </div>

        <!-- Schedule Information -->
        <div class="action-card mt-4">
            <h5><i class="bi bi-info-circle text-info me-2"></i>Информация о расписании</h5>
            <div class="row">
                <div class="col-md-6">
                    <ul class="list-unstyled mb-0">
                        <li><strong>Автоматические бэкапы:</strong> 1-го числа каждого месяца в 3:00</li>
                        <li><strong>Локальное хранение:</strong> 3 автоматических + 5 ручных</li>
                        <li><strong>Шифрование:</strong> AES-256 с PBKDF2 (100,000 итераций)</li>
                    </ul>
                </div>
                <div class="col-md-6">
                    {% if nas_config.get('enabled') %}
                    <ul class="list-unstyled mb-0">
                        <li><strong>NAS хранение:</strong> 12 последних месячных бэкапов</li>
                        <li><strong>Автозагрузка:</strong> Только для месячных бэкапов</li>
                        <li><strong>Протокол:</strong> CIFS/SMB</li>
                    </ul>
                    {% else %}
                    <div class="text-muted">
                        <em>NAS отключен. Для включения добавьте настройки в .env файл.</em>
                    </div>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Create Backup Modal -->
<div class="modal fade" id="createBackupModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Создание бэкапа</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="createBackupForm">
                    <div class="mb-3">
                        <label for="backup_password" class="form-label">Пароль для шифрования</label>
                        <input type="password" class="form-control" id="backup_password" 
                               placeholder="Минимум 8 символов" minlength="8" required>
                        <div class="form-text">Этот пароль потребуется для восстановления бэкапа</div>
                    </div>
                    <div class="mb-3">
                        <label for="backup_password_confirm" class="form-label">Подтвердите пароль</label>
                        <input type="password" class="form-control" id="backup_password_confirm" 
                               placeholder="Повторите пароль" required>
                    </div>
                </form>
                <div class="progress-container">
                    <div class="progress">
                        <div class="progress-bar progress-bar-striped progress-bar-animated" 
                             style="width: 0%"></div>
                    </div>
                    <small class="text-muted mt-2">Создание бэкапа может занять несколько минут...</small>
                </div>
                <div class="alert-container"></div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Отмена</button>
                <button type="button" class="btn btn-success" id="createBackupBtn">
                    <i class="bi bi-download me-1"></i>Создать бэкап
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Restore Backup Modal -->
<div class="modal fade" id="restoreBackupModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Восстановление из бэкапа</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div class="alert alert-warning">
                    <i class="bi bi-exclamation-triangle-fill me-2"></i>
                    <strong>Внимание!</strong> Восстановление полностью заменит все текущие данные и изображения.
                </div>
                <form id="restoreBackupForm" enctype="multipart/form-data">
                    <div class="mb-3">
                        <label for="backup_file" class="form-label">Файл бэкапа</label>
                        <input type="file" class="form-control" id="backup_file" 
                               accept=".encrypted" required>
                        <div class="form-text">Выберите файл с расширением .encrypted</div>
                    </div>
                    <div class="mb-3">
                        <label for="restore_password" class="form-label">Пароль для расшифровки</label>
                        <input type="password" class="form-control" id="restore_password" 
                               placeholder="Введите пароль от бэкапа" required>
                    </div>
                </form>
                <div class="progress-container">
                    <div class="progress">
                        <div class="progress-bar progress-bar-striped progress-bar-animated" 
                             style="width: 0%"></div>
                    </div>
                    <small class="text-muted mt-2">Восстановление может занять несколько минут...</small>
                </div>
                <div class="alert-container"></div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Отмена</button>
                <button type="button" class="btn btn-danger" id="restoreBackupBtn">
                    <i class="bi bi-upload me-1"></i>Восстановить
                </button>
            </div>
        </div>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
<script>
// Utility function to show messages
function showMessage(message, type = 'success') {
    // Create toast notification
    const toastContainer = document.getElementById('toast-container') || createToastContainer();
    const toast = document.createElement('div');
    toast.className = `toast align-items-center text-bg-${type === 'danger' ? 'danger' : type === 'success' ? 'success' : 'info'} border-0`;
    toast.setAttribute('role', 'alert');
    toast.innerHTML = `
        <div class="d-flex">
            <div class="toast-body">${message}</div>
            <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast"></button>
        </div>
    `;
    
    toastContainer.appendChild(toast);
    const bsToast = new bootstrap.Toast(toast);
    bsToast.show();
    
    // Remove toast after it's hidden
    toast.addEventListener('hidden.bs.toast', () => {
        toast.remove();
    });
}

function createToastContainer() {
    const container = document.createElement('div');
    container.id = 'toast-container';
    container.className = 'toast-container position-fixed top-0 end-0 p-3';
    container.style.zIndex = '1055';
    document.body.appendChild(container);
    return container;
}

// Create backup
document.getElementById('createBackupBtn').addEventListener('click', function() {
    const password = document.getElementById('backup_password').value;
    const confirmPassword = document.getElementById('backup_password_confirm').value;
    const alertContainer = document.querySelector('#createBackupModal .alert-container');
    
    // Clear previous messages
    alertContainer.innerHTML = '';
    
    // Validate passwords
    if (password !== confirmPassword) {
        alertContainer.innerHTML = '<div class="alert alert-danger">Пароли не совпадают</div>';
        return;
    }
    
    if (password.length < 8) {
        alertContainer.innerHTML = '<div class="alert alert-danger">Пароль должен содержать минимум 8 символов</div>';
        return;
    }
    
    // Show progress
    document.querySelector('#createBackupModal .progress-container').style.display = 'block';
    document.getElementById('createBackupBtn').disabled = true;
    
    // Progress animation
    let progress = 0;
    const progressBar = document.querySelector('#createBackupModal .progress-bar');
    const progressInterval = setInterval(() => {
        progress += Math.random() * 15;
        if (progress > 90) progress = 90;
        progressBar.style.width = progress + '%';
    }, 500);
    
    // Send request
    const formData = new FormData();
    formData.append('backup_password', password);
    
    fetch('/admin/backup/create', {
        method: 'POST',
        body: formData
    })
    .then(response => response.json())
    .then(data => {
        clearInterval(progressInterval);
        progressBar.style.width = '100%';
        
        if (data.success) {
            alertContainer.innerHTML = `<div class="alert alert-success">${data.message}</div>`;
            showMessage('Бэкап успешно создан!', 'success');
            setTimeout(() => {
                location.reload();
            }, 2000);
        } else {
            alertContainer.innerHTML = `<div class="alert alert-danger">Ошибка: ${data.error}</div>`;
        }
    })
    .catch(error => {
        clearInterval(progressInterval);
        alertContainer.innerHTML = '<div class="alert alert-danger">Произошла ошибка при создании бэкапа</div>';
    })
    .finally(() => {
        document.getElementById('createBackupBtn').disabled = false;
        setTimeout(() => {
            document.querySelector('#createBackupModal .progress-container').style.display = 'none';
            progressBar.style.width = '0%';
        }, 3000);
    });
});

// Restore backup
document.getElementById('restoreBackupBtn').addEventListener('click', function() {
    const fileInput = document.getElementById('backup_file');
    const password = document.getElementById('restore_password').value;
    const alertContainer = document.querySelector('#restoreBackupModal .alert-container');
    
    alertContainer.innerHTML = '';
    
    if (!fileInput.files[0]) {
        alertContainer.innerHTML = '<div class="alert alert-danger">Выберите файл бэкапа</div>';
        return;
    }
    
    if (!password) {
        alertContainer.innerHTML = '<div class="alert alert-danger">Введите пароль</div>';
        return;
    }
    
    if (!confirm('Вы действительно хотите восстановить данные из бэкапа? Все текущие данные будут заменены!')) {
        return;
    }
    
    // Show progress
    document.querySelector('#restoreBackupModal .progress-container').style.display = 'block';
    document.getElementById('restoreBackupBtn').disabled = true;
    
    // Progress animation
    let progress = 0;
    const progressBar = document.querySelector('#restoreBackupModal .progress-bar');
    const progressInterval = setInterval(() => {
        progress += Math.random() * 10;
        if (progress > 85) progress = 85;
        progressBar.style.width = progress + '%';
    }, 800);
    
    // Send request
    const formData = new FormData();
    formData.append('backup_file', fileInput.files[0]);
    formData.append('restore_password', password);
    
    fetch('/admin/backup/restore', {
        method: 'POST',
        body: formData
    })
    .then(response => response.json())
    .then(data => {
        clearInterval(progressInterval);
        progressBar.style.width = '100%';
        
        if (data.success) {
            alertContainer.innerHTML = `<div class="alert alert-success">${data.message}</div>`;
            showMessage('Бэкап успешно восстановлен!', 'success');
        } else {
            alertContainer.innerHTML = `<div class="alert alert-danger">Ошибка: ${data.error}</div>`;
        }
    })
    .catch(error => {
        clearInterval(progressInterval);
        alertContainer.innerHTML = '<div class="alert alert-danger">Произошла ошибка при восстановлении</div>';
    })
    .finally(() => {
        document.getElementById('restoreBackupBtn').disabled = false;
        setTimeout(() => {
            document.querySelector('#restoreBackupModal .progress-container').style.display = 'none';
            progressBar.style.width = '0%';
        }, 3000);
    });
});

// Test NAS connection
async function testNasConnection() {
    const btn = event.target;
    const originalText = btn.innerHTML;
    btn.disabled = true;
    btn.innerHTML = '<i class="spinner-border spinner-border-sm me-1"></i>Тестирование...';
    
    try {
        const response = await fetch('/admin/backup/test_nas', {
            method: 'POST'
        });
        
        const result = await response.json();
        
        if (result.success) {
            showMessage(result.message, 'success');
        } else {
            showMessage('Ошибка подключения к NAS: ' + result.error, 'danger');
        }
    } catch (error) {
        showMessage('Ошибка: ' + error.message, 'danger');
    } finally {
        btn.disabled = false;
        btn.innerHTML = originalText;
    }
}

// Upload to NAS
async function uploadToNas(filename) {
    if (!confirm('Загрузить бэкап ' + filename + ' на NAS?')) return;
    
    const btn = event.target;
    const originalText = btn.innerHTML;
    btn.disabled = true;
    btn.innerHTML = '<i class="spinner-border spinner-border-sm"></i>';
    
    try {
        const response = await fetch('/admin/backup/manual_nas_upload/' + filename, {
            method: 'POST'
        });
        
        const result = await response.json();
        
        if (result.success) {
            showMessage(result.message, 'success');
        } else {
            showMessage('Ошибка загрузки на NAS: ' + result.error, 'danger');
        }
    } catch (error) {
        showMessage('Ошибка: ' + error.message, 'danger');
    } finally {
        btn.disabled = false;
        btn.innerHTML = originalText;
    }
}

// Delete backup
async function deleteBackup(filename) {
    if (!confirm('Вы уверены, что хотите удалить бэкап ' + filename + '?')) return;
    
    const btn = event.target;
    const originalText = btn.innerHTML;
    btn.disabled = true;
    btn.innerHTML = '<i class="spinner-border spinner-border-sm"></i>';
    
    try {
        const response = await fetch('/admin/backup/delete/' + filename, {
            method: 'POST'
        });
        
        const result = await response.json();
        
        if (result.success) {
            showMessage('Бэкап удален: ' + filename, 'success');
            setTimeout(() => location.reload(), 1000);
        } else {
            showMessage('Ошибка удаления: ' + result.error, 'danger');
        }
    } catch (error) {
        showMessage('Ошибка: ' + error.message, 'danger');
    } finally {
        btn.disabled = false;
        btn.innerHTML = originalText;
    }
}

// Force monthly backup
async function forceMonthlyBackup() {
    if (!confirm('Создать принудительный месячный бэкап? Он будет отправлен на NAS, если он настроен.')) return;
    
    const btn = event.target;
    const originalText = btn.innerHTML;
    btn.disabled = true;
    btn.innerHTML = '<i class="spinner-border spinner-border-sm me-1"></i>Создание...';
    
    try {
        const response = await fetch('/admin/backup/force_monthly', {
            method: 'POST'
        });
        
        const result = await response.json();
        
        if (result.success) {
            showMessage(result.message, 'success');
            setTimeout(() => location.reload(), 2000);
        } else {
            showMessage('Ошибка: ' + result.error, 'danger');
        }
    } catch (error) {
        showMessage('Ошибка: ' + error.message, 'danger');
    } finally {
        btn.disabled = false;
        btn.innerHTML = originalText;
    }
}

// Reset forms when modals are closed
document.getElementById('createBackupModal').addEventListener('hidden.bs.modal', function() {
    document.getElementById('createBackupForm').reset();
    document.querySelector('#createBackupModal .alert-container').innerHTML = '';
    document.querySelector('#createBackupModal .progress-container').style.display = 'none';
    document.querySelector('#createBackupModal .progress-bar').style.width = '0%';
});

document.getElementById('restoreBackupModal').addEventListener('hidden.bs.modal', function() {
    document.getElementById('restoreBackupForm').reset();
    document.querySelector('#restoreBackupModal .alert-container').innerHTML = '';
    document.querySelector('#restoreBackupModal .progress-container').style.display = 'none';
    document.querySelector('#restoreBackupModal .progress-bar').style.width = '0%';
});
</script>
</body>
</html>