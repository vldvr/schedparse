# Настройка автоматических бэкапов на NAS

## Что изменилось

1. **Автобэкапы изменены с недельных на месячные** - теперь создаются 1-го числа каждого месяца в 3:00
2. **Добавлена поддержка NAS** - автоматическая загрузка месячных бэкапов на сетевое хранилище
3. **Улучшенная админ-панель** - новый интерфейс с поддержкой NAS функций

## Настройка NAS в .env файле

Добавьте следующие переменные в ваш `.env` файл:

```bash
# Включение NAS бэкапов
NAS_BACKUP_ENABLED=true

# Настройки подключения к NAS
NAS_HOST=192.168.1.100          # IP адрес вашего NAS
NAS_SHARE=backups               # Имя шары на NAS
NAS_USERNAME=backup_user        # Пользователь для подключения
NAS_PASSWORD=secure_password    # Пароль пользователя
NAS_BACKUP_PATH=schedparse_backups  # Папка внутри шары
NAS_DOMAIN=                     # Домен (оставить пустым для локальной сети)
```

## Примеры для разных NAS

### Synology NAS
```bash
NAS_HOST=192.168.1.100
NAS_SHARE=homes/backup_user     # или volume1/backups
NAS_USERNAME=backup_user
NAS_PASSWORD=your_password
NAS_BACKUP_PATH=schedparse
```

### QNAP NAS
```bash
NAS_HOST=192.168.1.101
NAS_SHARE=Public                # или Backup
NAS_USERNAME=admin
NAS_PASSWORD=your_password
NAS_BACKUP_PATH=schedparse_backups
```

### Windows Share
```bash
NAS_HOST=192.168.1.102
NAS_SHARE=SharedFolder
NAS_USERNAME=user
NAS_PASSWORD=password
NAS_DOMAIN=WORKGROUP           # или ваш домен
NAS_BACKUP_PATH=schedparse
```

## Как это работает

1. **Месячные автобэкапы**: Каждое 1-е число месяца в 3:00 утра создается зашифрованный бэкап
2. **Автоматическая загрузка**: Если NAS настроен, бэкап автоматически загружается на сетевое хранилище
3. **Управление местом**: 
   - Локально хранится 3 автоматических + 5 ручных бэкапов
   - На NAS хранится 12 последних месячных бэкапов (1 год)

## Функции админ-панели

- **Создать бэкап**: Создание ручного зашифрованного бэкапа
- **Восстановить бэкап**: Восстановление из локального файла
- **Месячный бэкап**: Принудительный запуск месячного бэкапа с загрузкой на NAS
- **Тест NAS**: Проверка подключения к сетевому хранилищу
- **Загрузка на NAS**: Ручная загрузка любого бэкапа на NAS

## Безопасность

- Все бэкапы зашифрованы AES-256 с PBKDF2 (100,000 итераций)
- Пароли не сохраняются в системе
- Соль генерируется случайно для каждого бэкапа
- Автоматические бэкапы используют пароль из переменной `AUTO_BACKUP_PASSWORD`

## Требования Docker

Контейнер нуждается в дополнительных привилегиях для монтирования NAS:

```yaml
services:
  schedparse:
    privileged: true
    cap_add:
      - SYS_ADMIN
    security_opt:
      - apparmor:unconfined
```

## Устранение неполадок

### NAS не монтируется
1. Проверьте сетевую доступность: `ping NAS_HOST`
2. Убедитесь что пользователь имеет права на запись
3. Проверьте что шара существует и доступна
4. Для Windows-шар может потребоваться указать домен

### Тест подключения не проходит
1. Используйте кнопку "Тест подключения" в админ-панели
2. Проверьте логи контейнера: `docker logs schedparse_app`
3. Убедитесь что `cifs-utils` установлен в контейнере

### Бэкапы не загружаются автоматически  
1. Проверьте что `NAS_BACKUP_ENABLED=true`
2. Убедитесь что планировщик работает
3. Проверьте логи на ошибки монтирования

## Мониторинг

Следите за логами для контроля работы системы:
```bash
docker logs -f schedparse_app
```

Логи покажут:
- Успешное создание бэкапов
- Статус загрузки на NAS  
- Ошибки подключения
- Очистку старых файлов